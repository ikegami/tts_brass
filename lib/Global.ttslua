debug = not not debug
devel = not not devel

local TableLock = require("kintastic/lib/TableLock")
TableLock.on_violation = ( debug or devel ) and TableLock.announce_violation or TableLock.ignore_violation
TableLock.lock(_G)
TableLock.declare_atom_symbols()

local Const = require("kintastic/lib/Const")
Const.on_violation = ( debug or devel ) and Const.announce_violation or Const.ignore_violation

if debug then require("kintastic/lib/Debug").import_into_global()    end
if devel then require("kintastic/lib/Devel").import_event_handlers() end

TableLock.declare_and_set(_G, "onLoad",
   function(saved_state_json)
      -- Loading a module doesn't clear this!!!
      -- https://forums.tabletopsimulator.com/showthread.php?9344-BUG-SCRIPT-Global-script_state-survives-load&p=29892
      -- We'll clear it ourselves to avoid having another module corrupt ours.
      Global.script_state = ""

      local App
      if game == "Lancashire" then
         App = require("mods/Brass/lib/App/Lancashire")
      elseif game == "Birmingham" then
         App = require("mods/Brass/lib/App/Birmingham")
      else
         error("Invalid value for \"game\".")
      end

      local app = App:new(saved_state_json)
      TableLock.declare_and_set(_G, "app", app)
      app:run()
   end
)
